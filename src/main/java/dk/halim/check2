
------------------------------------------
AUTHENTICATING CHIP USING Select Applet ID
------------------------------------------
CMD APDU 00A4040C07A0000002471001 2

Response Code = 9000
Status        = 9000 Applet ID confirmed

Document Number = A0467622
Corrected Document Number = A0467622<
Date of Birth = 08/06/1992
Date of Birth (ISO 8601:2000) = 920608
Date of Expiry = 23/12/2015
Date of Expiry (ISO 8601:2000) = 151223

Generated MRZ: A0467622<392060891512236

keySeed = SHA-1(MRZ)      = 04F1A9E467392E1E880436A7EF8386358B4B1074
keySeed 16-byte Truncated = 04F1A9E467392E1E880436A7EF838635
keySeedEnc = AEFDE59E6E7057F4588A526D896126E9
keySeedMAC = 40F4EF6D9B677A8F19107C8FB015DF67

---------------------------
GET CHIP IC / BAC CHALLENGE
---------------------------
CMD APDU 0084000008 10

Response Code = 9000
Chip IC (rnd.ICC) = FC66D268CF89A203

---------------------------------------------------
CHIP AUTHENTICATION & ESTABLISHMENT OF SESSION KEYS
---------------------------------------------------

Random rnd.IFD = 2C67EF826EC3E3D8
Random key.IFD = D048F9BEA55E1700BB62859D495A4B98

S   = rnd.IFD + rnd.ICC + key.IFD
S   = 2C67EF826EC3E3D8FC66D268CF89A203D048F9BEA55E1700BB62859D495A4B98
Enc = 0207010FD1161BAF410846C3DAF33942C0F730E1C2A9F2453A030E09B2D58AFF
MAC = 704DB64173E53782

cmd_data = 0207010FD1161BAF410846C3DAF33942C0F730E1C2A9F2453A030E09B2D58AFF704DB64173E53782

----------------------------------------
MUTUAL AUTHENTICATION (TERMINAL TO CARD)
----------------------------------------
CMD APDU 00820000280207010FD1161BAF410846C3DAF33942C0F730E1C2A9F2453A030E09B2D58AFF704DB64173E5378228 255

Response Code = 9000
Mutual Authentication Response = D9A41567D3F37F8D6BAA2654733D0D325A6534BA89E5BEACED7CC430577BF4A660020778E3EF22B2

Decrypted Chip Authentication = FC66D268CF89A2032C67EF826EC3E3D884D57890EC3EBA045AA30D5B3DD89F63

dec_rndICC     = FC66D268CF89A203
dec_rndIFD     = 2C67EF826EC3E3D8
dec_kICC       = 84D57890EC3EBA045AA30D5B3DD89F63
MAC (BAC Chal) = 60020778E3EF22B2
MAC (Expected) = 60020778E3EF22B2

Decrypted data has rndICC substring.
BAC Challenge is successful.

K_IC   = 84D57890EC3EBA045AA30D5B3DD89F63
K_seed = 549D812E4960AD04E1C188C67482D4FB
KSEnc  = 9801325E8602E570CE0B047613C81AEA
KSMAC  = 7AF1F8CD7997A41A5151D3AEC8AB2F0E

--------------------------------------
INITIALIZE SEND SEQUENCE COUNTER (SSC)
--------------------------------------

Concatenate the least 4 bytes from rnd.ICC and rnd.IFD
Last 4 from rnd.ICC = XXXXXXXX-CF89A203
Last 4 from rnd.IFC = XXXXXXXX-6EC3E3D8
SSC = CF89A2036EC3E3D8

-----------------------
READ FILE FROM THE CHIP
-----------------------

STEP 1: SELECT FILE

Command Header        = 0CA4020C
Padded Command Header = 0CA4020C80000000

Data Field           = 0102
Padded Data Field    = 0102800000000000
Encrypted Data Field = 7752478689DBF323

Build DO'87
DO87 = 8709017752478689DBF323

Concatenate CmdHeaderPadded and DO87
M = 0CA4020C800000008709017752478689DBF323

Incremented SSC = CF89A2036EC3E3D9

N = Concatenate SSC and M and add padding
    (NO PADDING WAS ADDED TO N)
N       = CF89A2036EC3E3D90CA4020C800000008709017752478689DBF323
MAC (N) = 2ACC24E4612B7A8B

DO8E = 8E082ACC24E4612B7A8B

Select {EF.COM}
ProtectedAPDU = 0CA4020C158709017752478689DBF3238E082ACC24E4612B7A8B00

RAPDU = 990290008E083D5509D30A2D601B9000

Verifying RAPDU
RAPDU_DO99  = 99029000
RAPDU_DO8E  = 3D5509D30A2D601B

Incremented SSC = CF89A2036EC3E3DA

K           = CF89A2036EC3E3DA99029000
MAC (K)     = 3D5509D30A2D601B
RAPDU_DO8E  = 3D5509D30A2D601B
RAPDU_DO8E == MAC (K) -> RAPDU is verified.

STEP 2: GET FIRST FOUR BYTES FROM THE SELECTED FILE

Command Header        = 0CB00000
Padded Command Header = 0CB0000080000000

Build DO'97
DO97 = 970104

Concatenate Padded CmdHeader and DO97
M = 0CB0000080000000970104

Incremented SSC = CF89A2036EC3E3DB

N   = Concatenate SSC and M
N   = CF89A2036EC3E3DB0CB0000080000000970104
MAC = 9A54860F5339B826

DO8E = 8E089A54860F5339B826

Get first four bytes
ProtectedAPDU = 0CB000000D9701048E089A54860F5339B82600

RAPDU = 870901D1C1D6020E0F4B5D990290008E084F169B8BC97681229000
RAPDU_DO87  = 870901D1C1D6020E0F4B5D
RAPDU_DO99  = 99029000
RAPDU_DO8E  = 4F169B8BC9768122

Incremented SSC = CF89A2036EC3E3DC

K           = SSC + DO87 + DO99
K           = CF89A2036EC3E3DC870901D1C1D6020E0F4B5D99029000
MAC (K)     = 4F169B8BC9768122
RAPDU_DO8E == MAC (K) -> RAPDU is verified.
82 = 16450

Decrypted DO87         = 7582403E
ASN1datalength code      = 82
File length in bytes     = 16450
Decrypted DO87 in bytes = 8

STEP 3: READ THE REMAINING CONTENT OF EF.COM

Last read byte position = 0

Command Header        = 0CB00000
Padded Command Header = 0CB0000080000000

DO97 = 970120

Concatenate Padded CmdHeader and DO97
M = 0CB0000080000000970120

Incremented SSC = CF89A2036EC3E3DD
N   = CF89A2036EC3E3DD0CB0000080000000970120
MAC = 74C70625E5428195

DO8E = 8E0874C70625E5428195

Get remaining file content
ProtectedAPDU = 0CB000000D9701208E0874C70625E542819500

RAPDU        = 872901701F3F8433D02D1A87FEC41204357EC0CF84295245E40078971E68D0E51D9CA0DB5A78160DFBD8AF990290008E08844F2AFFF98A7C280340
RAPDU length = 59
RAPDU_DO87   = 872901701F3F8433D02D1A87FEC41204357EC0CF84295245E40078971E68D0E51D9CA0DB5A78160DFBD8AF
RAPDU_DO99   = 99029000
RAPDU_DO8E   = 844F2AFFF98A7C28

Incremented SSC = CF89A2036EC3E3DE

K length    = 55
K           = SSC + DO87 + DO99
K           = CF89A2036EC3E3DE872901701F3F8433D02D1A87FEC41204357EC0CF84295245E40078971E68D0E51D9CA0DB5A78160DFBD8AF99029000
MAC (K)     = 844F2AFFF98A7CCC
RAPDU_DO8E != MAC (K) -> RAPDU is invalid.

Decrypted DO87       = 7582403E7F618240390201017F60824031A10C8002010087020101880200085F
DecryptedData length = 32
